name: Release Socks Proxy

on:
  push:
    tags: ["socks-v*"]

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5

      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#socks-v}
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Run tests
        run: |
          if compgen -G "tests/test_*.py" > /dev/null || compgen -G "tests/*_test.py" > /dev/null; then
            uv run --native-tls pytest
          else
            echo "No test files found, skipping"
          fi
        working-directory: socks-proxy

      - name: Update Homebrew formula
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone https://x-access-token:${TAP_TOKEN}@github.com/chrishham/homebrew-tap.git /tmp/homebrew-tap
          cd /tmp/homebrew-tap

          sed -i 's|archive/refs/tags/socks-v[^"]*\.tar\.gz|archive/refs/tags/'"${GITHUB_REF_NAME}"'.tar.gz|' Formula/netbridge-socks.rb
          sed -i 's|version ".*"|version "${{ steps.version.outputs.version }}"|' Formula/netbridge-socks.rb

          SHA=$(curl -sL "https://github.com/chrishham/netbridge/archive/refs/tags/${GITHUB_REF_NAME}.tar.gz" | sha256sum | cut -d' ' -f1)
          sed -i 's|sha256 ".*"|sha256 "'"${SHA}"'"|' Formula/netbridge-socks.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/netbridge-socks.rb
          if git diff --cached --quiet; then
            echo "Formula already up to date"
          else
            git commit -m "netbridge-socks ${{ steps.version.outputs.version }}"
            git push
          fi
